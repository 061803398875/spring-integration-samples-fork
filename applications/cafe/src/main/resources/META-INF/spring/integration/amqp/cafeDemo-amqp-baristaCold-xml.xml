<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:int="http://www.springframework.org/schema/integration"
	xmlns:int-amqp="http://www.springframework.org/schema/integration/amqp"
	xmlns:rabbit="http://www.springframework.org/schema/rabbit"
	xmlns:stream="http://www.springframework.org/schema/integration/stream"
	xmlns:cloud="http://schema.cloudfoundry.org/spring"
	xsi:schemaLocation="http://www.springframework.org/schema/beans
			http://www.springframework.org/schema/beans/spring-beans-3.1.xsd
			http://schema.cloudfoundry.org/spring
			http://schema.cloudfoundry.org/spring/cloudfoundry-spring-0.8.xsd
			http://www.springframework.org/schema/integration
			http://www.springframework.org/schema/integration/spring-integration-2.0.xsd
			http://www.springframework.org/schema/integration/amqp 
			http://www.springframework.org/schema/integration/amqp/spring-integration-amqp.xsd
			http://www.springframework.org/schema/rabbit 
			http://www.springframework.org/schema/rabbit/spring-rabbit-1.0.xsd
			http://www.springframework.org/schema/integration/stream
			http://www.springframework.org/schema/integration/stream/spring-integration-stream.xsd">


	<int-amqp:inbound-gateway 
		id="coldDrinksBarista"
		request-channel="coldJsonDrinks"
		queue-names="cold-drinks" 
		connection-factory="rabbitConnectionFactory" />

	<int:chain input-channel="coldJsonDrinks">
		<int:json-to-object-transformer type="org.springframework.integration.samples.cafe.OrderItem"/>
		<int:service-activator method="prepareColdDrink">
			<bean class="org.springframework.integration.samples.cafe.xml.Barista"/>
		</int:service-activator>
		<int:object-to-json-transformer />
	</int:chain>

	<!-- Use this when running locally -->
	<bean id="rabbitConnectionFactory" class="org.springframework.amqp.rabbit.connection.CachingConnectionFactory">
   		<constructor-arg value="localhost"/>
   		<property name="username" value="guest"/>
   		<property name="password" value="guest"/>
   	</bean>

	<!-- Use this when running in Cloud Foundry  -->
<!-- 	<cloud:rabbit-connection-factory id="rabbitConnectionFactory" service-name="cafe-rabbit"/> -->

	<rabbit:template id="amqpTemplate" connection-factory="rabbitConnectionFactory" />

	<rabbit:admin connection-factory="rabbitConnectionFactory" />
	
	<rabbit:topic-exchange name="cafe-drinks" auto-delete="true" durable="true">
		<rabbit:bindings>
			<rabbit:binding queue="cold-drinks" pattern="drink.cold"/>
			<rabbit:binding queue="all-cold-drinks" pattern="drink.cold"/>
		</rabbit:bindings>
	</rabbit:topic-exchange>
	
	<rabbit:queue name="cold-drinks" auto-delete="true" durable="true"/>	
	<rabbit:queue name="all-cold-drinks" auto-delete="true" durable="true"/>	

</beans>
